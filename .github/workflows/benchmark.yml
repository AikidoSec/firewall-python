name: Benchmark
on:
  push: {}
  workflow_call: {}
jobs:
  benchmark_sql_algorithm:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Start databases
        working-directory:  ./sample-apps/databases
        run: docker compose up --build -d
      - name: Set up Python 3.9
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          make dev_install
      - name: Install aikido_zen
        run: |
          make build
          mv ./dist/aikido_zen-*.tar.gz ./dist/aikido_zen.tar.gz
          pip install ./dist/aikido_zen.tar.gz
      - name: run sql benchmarks
        run: |
          poetry run python ./benchmarks/sql_benchmark/sql_benchmark_fw.py
          poetry run python ./benchmarks/sql_benchmark/sql_benchmark_no_fw.py
  benchmark_with_flask_mysql:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Start databases
        working-directory:  ./sample-apps/databases
        run: docker compose up --build -d
      - name: Start flask-mysql
        working-directory: ./sample-apps/flask-mysql
        run: |
          docker compose -f docker-compose.yml -f docker-compose.benchmark.yml up --build -d
      - name: Install K6
        uses: grafana/setup-k6-action@v1
      - name: Run flask-mysql k6 Benchmark
        run: |
          k6 run -q ./benchmarks/flask-mysql-benchmarks.js
  benchmark_with_starlette_app:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Start databases
        working-directory:  ./sample-apps/databases
        run: docker compose up --build -d
      - name: Start starlette multi-threaded
        working-directory: ./sample-apps/starlette-postgres-uvicorn
        run: |
          docker compose -f docker-compose.yml -f docker-compose.benchmark.yml up --build -d
      - name: Install wrk
        run: |
          sudo apt-get install build-essential libssl-dev git -y
          git clone https://github.com/wg/wrk.git wrk
          cd wrk
          sudo make
          sudo cp wrk /usr/local/bin
      - name: Do wrk testrun
        run: |
          wrk -t12 -c400 -d30s --latency http://127.0.0.1:8102/just
